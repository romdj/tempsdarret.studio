version: '3.9'

# Temps D'arrÃªt Microservices Platform
# All API traffic routes through Kong Gateway (port 8000)

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  # MongoDB - Shared database for all services
  mongodb:
    image: mongo:7-jammy
    container_name: tempsdarret-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin_password
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - tempsdarret_microservices
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka - Event bus
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: tempsdarret-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - tempsdarret_microservices
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Zookeeper - Required by Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    container_name: tempsdarret-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - tempsdarret_microservices

  # Redis - Caching and session storage
  redis:
    image: redis:7-alpine
    container_name: tempsdarret-redis
    ports:
      - "6379:6379"
    networks:
      - tempsdarret_microservices
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Microservices (Internal Network Only - No Direct External Access)
  # ============================================================================

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGODB_URI: mongodb://admin:admin_password@mongodb:27017/user-service?authSource=admin
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    # NOTE: No ports exposed - only accessible via Kong Gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3002/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Invite Service
  invite-service:
    build:
      context: ./services/invite-service
      dockerfile: Dockerfile
    container_name: invite-service
    environment:
      NODE_ENV: production
      PORT: 3003
      MONGODB_URI: mongodb://admin:admin_password@mongodb:27017/invite-service?authSource=admin
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    # NOTE: No ports exposed - only accessible via Kong Gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3003/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Portfolio Service
  portfolio-service:
    build:
      context: ./services/portfolio-service
      dockerfile: Dockerfile
    container_name: portfolio-service
    environment:
      NODE_ENV: production
      PORT: 3004
      MONGODB_URI: mongodb://admin:admin_password@mongodb:27017/portfolio-service?authSource=admin
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    # NOTE: No ports exposed - only accessible via Kong Gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3004/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Shoot Service
  shoot-service:
    build:
      context: ./services/shoot-service
      dockerfile: Dockerfile
    container_name: shoot-service
    environment:
      NODE_ENV: production
      PORT: 3005
      MONGODB_URI: mongodb://admin:admin_password@mongodb:27017/shoot-service?authSource=admin
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    # NOTE: No ports exposed - only accessible via Kong Gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3005/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # File Service
  file-service:
    build:
      context: ./services/file-service
      dockerfile: Dockerfile
    container_name: file-service
    environment:
      NODE_ENV: production
      PORT: 3006
      MONGODB_URI: mongodb://admin:admin_password@mongodb:27017/file-service?authSource=admin
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
      STORAGE_PATH: /app/storage
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      - file-storage:/app/storage
    networks:
      - tempsdarret_microservices
    # NOTE: No ports exposed - only accessible via Kong Gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3006/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Notification Service
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    environment:
      NODE_ENV: production
      PORT: 3007
      MONGODB_URI: mongodb://admin:admin_password@mongodb:27017/notification-service?authSource=admin
      KAFKA_BROKERS: kafka:9092
      REDIS_URL: redis://redis:6379
      RESEND_API_KEY: ${RESEND_API_KEY:-your_resend_api_key}
      PAYLOAD_SECRET: ${PAYLOAD_SECRET:-your_payload_secret}
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    # NOTE: No ports exposed - only accessible via Kong Gateway
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3007/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================================================
  # API Gateway (Single Public Entry Point)
  # ============================================================================

  # Kong Gateway - All external traffic must go through here
  kong-database:
    image: postgres:16-alpine
    container_name: kong-database
    environment:
      POSTGRES_USER: kong
      POSTGRES_DB: kong
      POSTGRES_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - tempsdarret_microservices
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  kong-migration:
    image: kong:3.7-alpine
    container_name: kong-migration
    command: kong migrations bootstrap
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PORT: 5432
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      KONG_PG_DATABASE: kong
    depends_on:
      kong-database:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    restart: on-failure

  kong:
    image: kong:3.7-alpine
    container_name: kong-gateway
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-database
      KONG_PG_PORT: 5432
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: ${KONG_DB_PASSWORD:-kong_password}
      KONG_PG_DATABASE: kong
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
    ports:
      - "8000:8000"  # HTTP API Gateway - ONLY PUBLIC ENDPOINT
      - "8443:8443"  # HTTPS API Gateway
      - "8001:8001"  # Admin API (should be firewalled in production)
      - "8444:8444"  # Admin API HTTPS
    depends_on:
      kong-database:
        condition: service_healthy
      kong-migration:
        condition: service_completed_successfully
      user-service:
        condition: service_healthy
      invite-service:
        condition: service_healthy
      portfolio-service:
        condition: service_healthy
      shoot-service:
        condition: service_healthy
      file-service:
        condition: service_healthy
      notification-service:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # Frontend (Connects to Kong Gateway Only)
  # ============================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: tempsdarret-frontend
    environment:
      # Frontend MUST use Kong Gateway, not direct service URLs
      VITE_API_BASE_URL: http://kong:8000
      PUBLIC_API_BASE_URL: http://localhost:8000
    ports:
      - "5173:5173"  # Vite dev server
      - "4173:4173"  # Vite preview
    depends_on:
      kong:
        condition: service_healthy
    networks:
      - tempsdarret_microservices
    volumes:
      - ./frontend:/app
      - /app/node_modules

volumes:
  mongodb-data:
    driver: local
  kong-db-data:
    driver: local
  file-storage:
    driver: local

networks:
  tempsdarret_microservices:
    driver: bridge
    name: tempsdarret_microservices
