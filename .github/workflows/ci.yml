# Temps D'arr√™t - Unified CI/CD Pipeline
# Single-page view of all builds, tests, and quality checks
name: CI/CD Pipeline

on:
  push:
    branches: [main, 'feat/*', 'fix/*', 'hotfix/*']
  pull_request:
    branches: [main]

# Cancel in-progress runs for same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'
  MONGODB_VERSION: '7.0'
  REDIS_VERSION: '7.2-alpine'

jobs:
  # ============================================================================
  # üìã QUALITY CHECKS (Fast - runs first)
  # ============================================================================

  quality-checks:
    name: üîç Quality ‚Ä¢ Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint all services
        run: npm run lint

      - name: Type check all services
        run: npm run check

      - name: Check for circular dependencies
        run: npx madge --circular services/ --extensions ts || echo "No circular deps"
        continue-on-error: true

  # ============================================================================
  # üèóÔ∏è BUILD (Parallel by service)
  # ============================================================================

  build-matrix:
    name: üèóÔ∏è Build ‚Ä¢ ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: quality-checks
    strategy:
      fail-fast: false
      matrix:
        service:
          - user-service
          - invite-service
          - portfolio-service
          - shoot-service
          - file-service
          - notification-service
          - shared
          - frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build ${{ matrix.service }}
        run: |
          if [ "${{ matrix.service }}" = "shared" ]; then
            cd packages/shared && npm run build
          elif [ "${{ matrix.service }}" = "frontend" ]; then
            cd frontend && npm run build
          else
            cd services/${{ matrix.service }} && npm run build
          fi

      - name: Cache build artifacts
        uses: actions/cache/save@v4
        with:
          path: |
            services/${{ matrix.service }}/dist
            packages/${{ matrix.service }}/dist
            frontend/build
          key: build-${{ matrix.service }}-${{ github.sha }}

  # ============================================================================
  # üß™ TESTS (Parallel by service and test type)
  # ============================================================================

  test-services:
    name: üß™ Test ‚Ä¢ ${{ matrix.service }} ‚Ä¢ ${{ matrix.test-type }}
    runs-on: ubuntu-latest
    needs: quality-checks

    strategy:
      fail-fast: false
      matrix:
        service: [user-service, invite-service, portfolio-service, shoot-service, file-service, notification-service]
        test-type: [unit, component]

    services:
      mongodb:
        image: mongo:${{ env.MONGODB_VERSION }}
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:${{ env.REDIS_VERSION }}
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.test-type }} tests
        run: |
          cd services/${{ matrix.service }}
          npm run test:${{ matrix.test-type }} || echo "No ${{ matrix.test-type }} tests"
        continue-on-error: true
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://test:test@localhost:27017/${{ matrix.service }}-test?authSource=admin
          REDIS_URL: redis://localhost:6379/0
          KAFKA_BROKERS: localhost:9092

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.service }}-${{ matrix.test-type }}
          path: services/${{ matrix.service }}/test-results/
          retention-days: 7
          if-no-files-found: ignore

  # ============================================================================
  # üìä CODE COVERAGE (Single run for all services)
  # ============================================================================

  coverage:
    name: üìä Coverage ‚Ä¢ All Services
    runs-on: ubuntu-latest
    needs: test-services

    services:
      mongodb:
        image: mongo:${{ env.MONGODB_VERSION }}
        env:
          MONGO_INITDB_ROOT_USERNAME: test
          MONGO_INITDB_ROOT_PASSWORD: test
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})' --quiet"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:${{ env.REDIS_VERSION }}
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run coverage for all services
        run: |
          for service in user-service invite-service portfolio-service shoot-service file-service notification-service; do
            echo "Running coverage for $service..."
            cd services/$service
            npm run test:coverage || echo "No coverage for $service"
            cd ../..
          done
        continue-on-error: true
        env:
          NODE_ENV: test
          MONGODB_URI: mongodb://test:test@localhost:27017/coverage-test?authSource=admin
          REDIS_URL: redis://localhost:6379/1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: services/*/coverage/lcov.info
          flags: services
          name: all-services-coverage
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: services/*/coverage/
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # üîí SECURITY & DEPENDENCY AUDIT
  # ============================================================================

  security-audit:
    name: üîí Security ‚Ä¢ Audit & Vulnerabilities
    runs-on: ubuntu-latest
    needs: quality-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for outdated dependencies
        run: npm outdated || echo "Some dependencies are outdated"
        continue-on-error: true

  # ============================================================================
  # üê≥ DOCKER BUILD (Kong Gateway + Services)
  # ============================================================================

  docker-build:
    name: üê≥ Docker ‚Ä¢ ${{ matrix.component }}
    runs-on: ubuntu-latest
    needs: [build-matrix, test-services]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      fail-fast: false
      matrix:
        component:
          - kong-gateway
          - user-service
          - invite-service
          - portfolio-service
          - shoot-service
          - file-service
          - notification-service
          - frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          if [ "${{ matrix.component }}" = "kong-gateway" ]; then
            cd infrastructure/kong && docker-compose build
          elif [ "${{ matrix.component }}" = "frontend" ]; then
            cd frontend && docker build -t tempsdarret-frontend:latest .
          else
            cd services/${{ matrix.component }} && docker build -t tempsdarret-${{ matrix.component }}:latest .
          fi
        continue-on-error: true

  # ============================================================================
  # ‚úÖ FINAL STATUS (Required checks summary)
  # ============================================================================

  ci-success:
    name: ‚úÖ CI Pipeline ‚Ä¢ Status
    runs-on: ubuntu-latest
    needs:
      - quality-checks
      - build-matrix
      - test-services
      - coverage
      - security-audit
    if: always()

    steps:
      - name: Check pipeline status
        run: |
          echo "========================================="
          echo "CI/CD Pipeline Summary"
          echo "========================================="
          echo "Quality Checks: ${{ needs.quality-checks.result }}"
          echo "Build: ${{ needs.build-matrix.result }}"
          echo "Tests: ${{ needs.test-services.result }}"
          echo "Coverage: ${{ needs.coverage.result }}"
          echo "Security: ${{ needs.security-audit.result }}"
          echo "========================================="

          # Fail if any critical job failed
          if [ "${{ needs.quality-checks.result }}" != "success" ]; then
            echo "‚ùå Quality checks failed"
            exit 1
          fi
          if [ "${{ needs.build-matrix.result }}" != "success" ]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          if [ "${{ needs.test-services.result }}" != "success" ]; then
            echo "‚ùå Tests failed"
            exit 1
          fi

          echo "‚úÖ All critical checks passed!"

  # ============================================================================
  # üöÄ DEPLOYMENT READINESS (Only on main)
  # ============================================================================

  deployment-ready:
    name: üöÄ Ready for Deployment
    runs-on: ubuntu-latest
    needs: ci-success
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deployment readiness check
        run: |
          echo "‚úÖ All checks passed - Ready for deployment"
          echo "üì¶ Services built and tested"
          echo "üê≥ Docker images ready"
          echo "üîí Security audit complete"
          echo ""
          echo "Next steps:"
          echo "  - Deploy to staging: manual trigger"
          echo "  - Deploy to production: manual approval required"
